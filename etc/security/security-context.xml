<?xml version="1.0" encoding="UTF-8"?>

<!-- Security configuration -->
<!-- namespace docs: http://static.springsource.org/spring-security/site/docs/3.1.x/reference/appendix-namespace.html -->
<beans:beans xmlns="http://www.springframework.org/schema/security"
    xmlns:oauth="http://www.springframework.org/schema/security/oauth2"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/security/oauth2 
        http://www.springframework.org/schema/security/spring-security-oauth2-1.0.xsd 
    	http://www.springframework.org/schema/beans 
    	http://www.springframework.org/schema/beans/spring-beans.xsd 
    	http://www.springframework.org/schema/security 
    	http://www.springframework.org/schema/security/spring-security-3.1.xsd">

	<!-- Bean definitions -->
    <beans:bean id="propertyPlaceholderConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer" />
    <beans:bean id="evoUserDetailsService" class="co.fs.evo.security.EvoUserDetailsService" />
    <beans:bean id="passwordEncoder" class="org.springframework.security.authentication.encoding.ShaPasswordEncoder">
    	<beans:constructor-arg value="256"/>
    </beans:bean>
    <beans:bean class="org.springframework.security.authentication.dao.ReflectionSaltSource" id="saltSource">
     	<beans:property name="userPropertyToUse" value="uid"/>
	</beans:bean>
	
	<!-- ############################### OAUTH2 START ############################### -->
	
	<beans:bean id="oauthAuthenticationEntryPoint" class="org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint">
        <beans:property name="realmName" value="evo" />
    </beans:bean>
    
    <beans:bean id="oauthAccessDeniedHandler" class="org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler" />
    
    <beans:bean id="accessDecisionManager" class="org.springframework.security.access.vote.UnanimousBased">
        <beans:constructor-arg>
            <beans:list>
                <beans:bean class="org.springframework.security.oauth2.provider.vote.ScopeVoter" />
                <beans:bean class="org.springframework.security.access.vote.RoleVoter" />
                <beans:bean class="org.springframework.security.access.vote.AuthenticatedVoter" />
            </beans:list>
        </beans:constructor-arg>
    </beans:bean>
    
    <beans:bean id="userApprovalHandler" class="co.fs.evo.security.OAuthApprovalHandler">
        <beans:property name="autoApproveClients">
            <beans:set>
                <beans:value>my-less-trusted-autoapprove-client</beans:value>
            </beans:set>
        </beans:property>
        <beans:property name="tokenServices" ref="tokenServices" />
    </beans:bean>
    
    <oauth:resource-server id="resourceServerFilter" resource-id="evo" token-services-ref="tokenServices" />
    
    <beans:bean id="tokenStore" class="org.springframework.security.oauth2.provider.token.InMemoryTokenStore" />
    
    <!-- Responsible for creating actual tokens -->
    <beans:bean id="tokenServices" class="org.springframework.security.oauth2.provider.token.DefaultTokenServices">
        <beans:property name="tokenStore" ref="tokenStore" />
        <beans:property name="supportRefreshToken" value="true" />
        <beans:property name="clientDetailsService" ref="clientDetails" />
    </beans:bean>
    
    <!-- oauth client/s -->
    <oauth:client-details-service id="clientDetails">
        <oauth:client 
            client-id="admin" 
            authorized-grant-types="client_credentials,password,refresh_token"
            authorities="ROLE_CLIENT" 
            scope="read,write" 
            secret="123" />
    </oauth:client-details-service>
    
    <!-- ############################### OAUTH2 END ############################### -->

    <!-- enables method annotation -->
    <global-method-security pre-post-annotations="enabled" />

	<!-- no need to secure static resources -->
    <http pattern="/css/**" security="none"/>
    <http pattern="/js/**" security="none"/>
    <http pattern="/img/**" security="none"/>
    <!--http pattern="/v1/**" security="none"/-->
    
    <!-- Protect the token service -->
    <http pattern="/oauth/token" create-session="stateless" authentication-manager-ref="authenticationManager">
        <intercept-url pattern="/oauth/token" access="IS_AUTHENTICATED_FULLY" />
        <anonymous enabled="false" />
        <http-basic />
        <access-denied-handler ref="oauthAccessDeniedHandler" />
    </http>
    
    <http pattern="/v1/**" create-session="stateless" entry-point-ref="oauthAuthenticationEntryPoint" use-expressions="true">
        <anonymous enabled="false" />
        <!--intercept-url pattern="/v1/**" access="hasRole('supervisor')" /-->
        <intercept-url pattern="/v1/**" access="hasRole('ROLE_CLIENT')" />
        <custom-filter ref="resourceServerFilter" before="PRE_AUTH_FILTER" />
        <access-denied-handler ref="oauthAccessDeniedHandler" />
    </http>

    <http use-expressions="true" disable-url-rewriting="true">
    
    	<!-- Used for Spring redirects -->
    	<port-mappings>
     		<port-mapping http="${evo.http.port:2600}" https="${evo.https.port:2643}" />
   		</port-mappings>
   
    	<!-- Everyone can access the login page -->
    	<intercept-url pattern="/login.html" access="permitAll" />
    	
    	<!-- Administrative Interface Security Rules -->
    	<intercept-url pattern="/evo/**" access="hasRole('supervisor')" />
    	
    	<!-- Comment out the above intercept and uncomment the following to force login over https -->
    	<!--
    	<intercept-url pattern="/evo/**" access="hasRole('supervisor')" requires-channel="https" />
        -->
        
        <!-- API Security Rules -->
        <!--intercept-url pattern="/v1/apps/**" access="isAuthenticated()" /-->
        <!--intercept-url pattern="/v1/**" access="isAuthenticated()" /-->
        
        <form-login 
        	login-page="/login.html" 
        	login-processing-url="/evo_login" 
        	authentication-failure-url="/login.html" />
        	
        <logout
        	logout-url="/logout"
        	logout-success-url="/login.html" 
        	delete-cookies="JSESSIONID" 
        	invalidate-session="true" />
        <!-- remember-me / -->
        
        <!-- Enable X509 client authentication support -->
        <!--x509 /-->

        <!-- Limit the number of sessions a user can have -->
        <!--session-management invalid-session-url="/timeout.jsp">
            <concurrency-control max-sessions="1" error-if-maximum-exceeded="true" />
        </session-management-->

    </http>
    
    <authentication-manager alias="authenticationManager" erase-credentials="false">
        
    	<!-- Evo provider -->
    	<authentication-provider user-service-ref="evoUserDetailsService">
    		<password-encoder ref="passwordEncoder">
    			<salt-source ref="saltSource"/>
    		</password-encoder>
    	</authentication-provider>
    	
    	<!-- Memory based (test) provider: admin:admin
        <authentication-provider>
            <password-encoder ref="passwordEncoder"/>
            <user-service>
                <user name="admin" password="d033e22ae348aeb5660fc2140aec35850c4da997" authorities="supervisor, user, teller" />
            </user-service>
        </authentication-provider>-->

    </authentication-manager>

</beans:beans>
